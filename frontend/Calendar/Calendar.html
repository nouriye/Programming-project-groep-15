<!DOCTYPE html>
<html lang='en'>
<head> 
    <meta charset='UTF-8'>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script>
       // let idToestel=sessionStorage.getItem('prodID');
        document.addEventListener('DOMContentLoaded', function() {
            var unavailableDates = []; 
            
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                events: [], 
                select: function(data) {
                    var BeginDatum = data.startStr;
                    
                    
                    var EindDatum = new Date(data.end);     
                    EindDatum.setDate(EindDatum.getDate());
                    EindDatum = EindDatum.toISOString().split('T')[0];
                    //product id van geselecteerd item uit sessionstorage halen
                    let idToestel=sessionStorage.getItem('prodID');
                    let toestelnaam=sessionStorage.getItem('prodnaam');
                    let stuid=sessionStorage.getItem('stuid');
                    let stunaam=sessionStorage.getItem('stunaam');
                    let stumail=sessionStorage.getItem('email');
                    console.log(BeginDatum, EindDatum,idToestel,toestelnaam,stuid,stunaam,stumail);
                   
                    





                    getdatafromCalender("http://localhost:3000/uitleentermijn", "POST", {
                        ToestelId: idToestel,
                        prodnaam:toestelnaam,
                        stuid:stuid,
                        stunaam:stunaam,
                        stumail:stumail,
                        Startdatum: BeginDatum,
                        Einddatum: EindDatum
                    }).then(data => {
                        // sessionStorage.setItem('product', JSON.stringify(data))
                        window.location.href = "../bevestiging/bevestiging.html";
                    }).then(resp => {
                        console.log(resp);
                    }).catch(error => {
                        console.error('Error:', error);
                    });
                },
                selectAllow: function(selectInfo) {
                    return isSelectionAllowed(selectInfo.start, selectInfo.end);
                }
            });

            calendar.render();

           
            fetchUnavailableDates().then(events => {
                unavailableDates = events.map(event => ({
                    start: new Date(event.start),
                    end: new Date(event.end)
                }));

                events.forEach(event => {
                    try {
                        
                        var endDate = new Date(event.end);
                        if (!isNaN(endDate.getTime())) {
                            endDate.setDate(endDate.getDate());
                            event.end = endDate.toISOString().split('T')[0];
                        } else {
                            console.error('Invalid end date:', event.end);
                        }
                    } catch (e) {
                        console.error('Error processing end date:', e, event.end);
                    }
                    calendar.addEvent(event);
                });
            });

            function isSelectionAllowed(start, end) {
                for (let i = 0; i < unavailableDates.length; i++) {
                    if (
                        (start >= unavailableDates[i].start && start < unavailableDates[i].end) ||
                        (end > unavailableDates[i].start && end <= unavailableDates[i].end) ||
                        (start < unavailableDates[i].start && end > unavailableDates[i].end)
                    ) {
                        return false;
                    }
                }
                return true;
            }
        });

        async function getdatafromCalender(url, method, data) {
            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': "application/json",
                    },
                    body: JSON.stringify(data)
                });

                return await resp.json();
            } catch (error) {
                throw error;
            }
        } 
  
        async function fetchUnavailableDates() {
            let idToestel=sessionStorage.getItem('prodID');
            try {
               
                const response = await fetch(`http://localhost:3000/unavailable-dates/${idToestel}`);
                const data = await response.json();
                return data.map(item => ({
                    start: item.sdatum, 
                    end: item.edatum, 
                    display: 'background',
                    color: 'red'
                }));
            } catch (error) {
                console.error('Error fetching unavailable dates:', error);
                return [];
            }   
        }
         
        function getperson(){
            window.location.href = "../calendar getuser/getuser.html";
        }
    </script>
</head>
<body> 
    <div id='calendar'></div>
</body>
</html>